<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company News Aggregator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS -->
    <script crossorigin src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
    </style>
</head>

<body>
    <div id="debug-error"
        style="background: #fee2e2; color: #991b1b; padding: 20px; display: none; margin: 20px; border: 1px solid #f87171; border-radius: 8px;">
        <h3 style="font-weight: bold; margin-bottom: 8px;">Startup Error</h3>
        <pre id="debug-content" style="white-space: pre-wrap; font-family: monospace;"></pre>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function (msg, url, line, col, error) {
            document.getElementById('debug-error').style.display = 'block';
            document.getElementById('debug-content').textContent += `Error: ${msg}\nAt: ${url}:${line}:${col}\n\n`;
            return false;
        };
    </script>

    <script type="text/babel">
        try {
            const { useState, useEffect } = React;

            // Checks
            if (typeof XLSX === 'undefined') throw new Error("SheetJS failed to load.");

            // --- UTILS ---

            function levenshtein(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                const matrix = [];
                for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
                            );
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            function isSimilar(s1, s2, threshold = 0.6) { // Lower threshold for headlines
                if (!s1 || !s2) return false;
                const longer = s1.length > s2.length ? s1 : s2;
                if (longer.length === 0) return true;
                const dist = levenshtein(s1.toLowerCase(), s2.toLowerCase());
                return (longer.length - dist) / longer.length >= threshold;
            }

            // --- APP ---

            function App() {
                const [status, setStatus] = useState("idle");
                const [targetCompanies, setTargetCompanies] = useState("");
                const [startDate, setStartDate] = useState("");
                const [endDate, setEndDate] = useState("");
                const [newsItems, setNewsItems] = useState([]);
                const [progress, setProgress] = useState("");

                const fetchNews = async () => {
                    if (!targetCompanies) { alert("Please enter companies."); return; }

                    setStatus("processing");
                    setNewsItems([]);

                    const companies = targetCompanies.split(',').map(c => c.trim()).filter(c => c);
                    if (companies.length === 0) { alert("Invalid companies."); setStatus("idle"); return; }

                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (end) end.setHours(23, 59, 59);

                    let aggregatedNews = [];

                    for (let i = 0; i < companies.length; i++) {
                        const company = companies[i];
                        setProgress(`Searching news for: ${company} (${i + 1}/${companies.length})`);

                        try {
                            // Use Google News RSS via public proxy
                            // NOTE: Valid search query `q={COMPANY}+after:{YYYY-MM-DD}+before:{YYYY-MM-DD}` is best for Google News
                            let query = encodeURIComponent(company);
                            if (startDate) query += `+after:${startDate}`;
                            if (endDate) query += `+before:${endDate}`;

                            const rssUrl = `https://news.google.com/rss/search?q=${query}&hl=en-US&gl=US&ceid=US:en`;
                            // Using rss2json.com is common for simple JS apps, but limited.
                            // Alternative: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`

                            const proxyUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

                            const res = await fetch(proxyUrl);
                            const data = await res.json();

                            if (data.status === 'ok' && data.items) {
                                data.items.forEach(item => {
                                    // Parse Date
                                    const pubDate = new Date(item.pubDate); // "2023-01-01 10:00:00"

                                    // Client-side date filter (double check)
                                    if (start && pubDate < start) return;
                                    if (end && pubDate > end) return;

                                    aggregatedNews.push({
                                        title: item.title,
                                        link: item.link,
                                        date: pubDate,
                                        source: "Google News",
                                        company: company,
                                        description: item.description
                                    });
                                });
                            }
                        } catch (e) {
                            console.error(`Failed to fetch for ${company}`, e);
                        }

                        // Avoid rate limits
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    setProgress("Deduplicating results...");

                    // Deduplicate
                    const unique = [];
                    aggregatedNews.forEach(item => {
                        // Check if similar title exists
                        const exists = unique.some(u => isSimilar(u.title, item.title));
                        if (!exists) {
                            unique.push(item);
                        }
                    });

                    // Sort by date desc
                    unique.sort((a, b) => b.date - a.date);

                    setNewsItems(unique);
                    setStatus("done");
                    setProgress("");
                };

                const handleDownload = () => {
                    if (newsItems.length === 0) return;

                    const dataForExcel = newsItems.map(item => ({
                        Date: item.date.toLocaleDateString(),
                        Company: item.company,
                        Title: item.title,
                        Link: item.link
                    }));

                    const ws = XLSX.utils.json_to_sheet(dataForExcel);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "News");
                    XLSX.writeFile(wb, "Company_News.xlsx");
                };

                return (
                    <div className="max-w-5xl mx-auto p-10 font-sans text-slate-800">
                        <header className="mb-10 text-center">
                            <h1 className="text-4xl font-extrabold text-blue-700 mb-2">Company News Aggregator</h1>
                            <p className="text-slate-500 text-lg">Search, deduplicate, and export news for multiple companies instantly.</p>
                        </header>

                        <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-100 mb-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="col-span-2">
                                    <label className="block text-sm font-bold text-slate-700 mb-2">Target Companies (Comma separated)</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg"
                                        placeholder="e.g. OpenAI, Microsoft, Google"
                                        value={targetCompanies}
                                        onChange={e => setTargetCompanies(e.target.value)}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                                    <input
                                        type="date"
                                        className="w-full p-2 border border-slate-300 rounded-lg"
                                        value={startDate}
                                        onChange={e => setStartDate(e.target.value)}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                                    <input
                                        type="date"
                                        className="w-full p-2 border border-slate-300 rounded-lg"
                                        value={endDate}
                                        onChange={e => setEndDate(e.target.value)}
                                    />
                                </div>
                            </div>

                            <button
                                onClick={fetchNews}
                                disabled={status === 'processing'}
                                className={`w-full py-3 rounded-lg font-bold text-white transition
                                    ${status === 'processing' ? 'bg-blue-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700 shadow-md'}
                                `}
                            >
                                {status === 'processing' ? 'Processing...' : 'Search News'}
                            </button>

                            {progress && (
                                <div className="mt-4 text-center text-sm font-medium text-blue-600 animate-pulse">
                                    {progress}
                                </div>
                            )}
                        </div>

                        {/* Results */}
                        {status === 'done' && (
                            <div className="fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold text-slate-800">Results ({newsItems.length})</h2>
                                    <button
                                        onClick={handleDownload}
                                        disabled={newsItems.length === 0}
                                        className="bg-green-600 text-white px-6 py-2 rounded-lg font-medium shadow hover:bg-green-700 transition"
                                    >
                                        Download Excel
                                    </button>
                                </div>

                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    {newsItems.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="p-4 font-semibold text-slate-600 w-32">Date</th>
                                                        <th className="p-4 font-semibold text-slate-600 w-40">Company</th>
                                                        <th className="p-4 font-semibold text-slate-600">Headline</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {newsItems.map((item, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-50 transition">
                                                            <td className="p-4 text-slate-500 whitespace-nowrap text-sm">
                                                                {item.date.toLocaleDateString()}
                                                            </td>
                                                            <td className="p-4 font-medium text-slate-800">
                                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                                    {item.company}
                                                                </span>
                                                            </td>
                                                            <td className="p-4">
                                                                <a href={item.link} target="_blank" className="text-blue-600 hover:underline font-medium block mb-1">
                                                                    {item.title}
                                                                </a>
                                                                <div className="text-xs text-slate-400 max-w-2xl truncate">
                                                                    {item.description ? item.description.replace(/<[^>]*>?/gm, '') : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="p-10 text-center text-slate-400 bg-slate-50">
                                            No news found. Try broadening your date range.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);

        } catch (err) {
            console.error(err);
            document.getElementById('debug-error').style.display = 'block';
            document.getElementById('debug-content').textContent += `App Error: ${err.message}\n${err.stack}`;
        }
    </script>
</body>

</html>